<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark" />
<title>Financial Tracker</title>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #10151c;
    --panel-2: #141a22;
    --text: #e6edf3;
    --muted: #aab6c3;
    --accent: #7c3aed;
    --accent-2: #22d3ee;
    --danger: #ef4444;
    --ok: #22c55e;
    --input: #0f1720;
    --border: #1f2a37;
    --chip: #18202d;
    --row-alt: #0f141b;
    --focus: #7c3aed;
  }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; overflow-x:hidden; }
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  .wrap { width: 100%; max-width: 520px; margin: 0 auto; padding: 12px 14px 80px; }
  h1 { font-size: 1.25rem; margin: 0 0 10px; font-weight: 800; letter-spacing: 0.2px; }

  /* Tabs */
  .tabs { position: sticky; top: 0; z-index: 50; display:flex; gap:8px; margin:0 0 12px; padding: 8px 0; background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.8)); backdrop-filter: blur(6px); }
  .tab-btn { flex:1; text-align:center; background:var(--panel); border:1px solid var(--border); color:var(--text); padding:12px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size: 0.95rem; min-width:0; }
  .tab-btn.active { background: var(--accent); border-color: var(--accent); }

  /* Cards */
  .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset; overflow-x:hidden; }

  /* Grid */
  .row { display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px; }
  @media (min-width: 480px){ .row { grid-template-columns: repeat(12, 1fr); } .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; } }
  label { display:block; font-size:.85rem; margin-bottom:6px; color:var(--muted); font-weight:600; }

  input[type="date"], input[type="number"], input[type="text"], select {
    width:100%; background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:12px;
    padding:14px 12px; outline:none; font-size:16px; line-height:1.2; height: 44px; 
    -webkit-appearance: none; appearance: none;
  }
  input:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(124,58,237,.25); }
  input[type=date]::-webkit-calendar-picker-indicator{ filter: invert(1) opacity(.8); }

  .btn { width:100%; background:var(--accent); border:1px solid var(--accent); color:white; padding:14px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:1rem; letter-spacing:.2px; }
  .btn.secondary { width:auto; background: transparent; border:1px solid var(--border); padding:12px 14px; border-radius:12px; font-weight:700; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }

  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:.8rem; color:var(--muted); }

  /* Totals */
  .totals.stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; align-items:stretch; }
  .total.stat { text-align:center; padding:12px; border-radius:14px; border:1px solid var(--border); background: linear-gradient(180deg, var(--panel), var(--panel-2)); min-width:0; }
  .total.stat strong { display:block; font-size:.78rem; color:var(--muted); font-weight:800; letter-spacing:.2px; margin-bottom:4px; }
  .total.stat span { display:block; font-size:1.25rem; font-weight:900; }
  .total.stat.ok span { color: var(--ok); }
  .total.stat.danger span { color: var(--danger); }
  .total.stat.neutral span { color: var(--text); }

  /* Table */
  table { width:100%; border-collapse: collapse; margin-top:8px; table-layout: fixed; }
  th, td { text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); word-break: break-word; overflow-wrap: anywhere; hyphens: auto; }
  thead th { font-size:.8rem; color:var(--muted); text-transform: uppercase; letter-spacing:.04em; }
  tbody tr:nth-child(even) { background: var(--row-alt); }
  .log-table tbody tr { transition: background .15s ease, transform .05s ease; }
  .log-table tbody tr:hover { background: rgba(124,58,237,.08); }
  .delete-btn { background: transparent; color: var(--danger); border:1px solid var(--danger); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; }
  .delete-btn:hover { background: rgba(239,68,68,.1); }

  /* Responsive rows */
  @media (max-width: 640px){
    thead { display:none; }
    table, tbody, tr, td { display:block; width:100%; }
    tr { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; margin-bottom:10px; overflow:hidden; }
    td { border: none; padding: 10px 12px 10px 112px; position: relative; min-height: 44px; }
    td::before { content: attr(data-col); position: absolute; left: 12px; top: 10px; color: var(--muted); font-size: .78rem; font-weight: 700; letter-spacing: .2px; }
    td:last-child { padding-left: 12px; display:flex; justify-content:flex-end; }
  }

  .toast { position:fixed; right:12px; bottom:12px; background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; opacity:0; transform: translateY(10px); transition: all .2s ease; pointer-events:none; }
  .toast.show { opacity:1; transform: translateY(0); }

  /* Sticky bottom action */
  .sticky-actions { position: sticky; bottom: 0; padding-top: 8px; background: linear-gradient(180deg, transparent, rgba(11,15,20,.9)); }

  /* Table controls */
  .table-controls { display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; max-width:100%; }
  .table-controls .date-inline label { display:block; font-size:.78rem; color:var(--muted); margin-bottom:4px; font-weight:700; line-height:1.1; }
  .table-controls input[type="date"] { width:100%; background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px; height: 40px; line-height:1.2; -webkit-appearance:none; appearance:none; }
  @media (max-width: 420px){ .table-controls { grid-template-columns: 1fr; } }

  /* Tiny screens: keep 3 stats readable */
  @media (max-width: 400px){ .total.stat { padding: 8px; } .total.stat strong { font-size: .72rem; } .total.stat span { font-size: 1.05rem; } }
  @media (max-width: 340px){ .total.stat { padding: 6px; } .total.stat strong { font-size: .68rem; } .total.stat span { font-size: .98rem; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Financial Tracker</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="income">Income</button>
    <button class="tab-btn" data-tab="expenses">Expenses</button>
    <button class="tab-btn" data-tab="view">View</button>
  </div>

  <section id="tab-income" class="card">
    <div class="row">
      <div class="col-4">
        <label for="inc-date">Date</label>
        <input type="date" id="inc-date" />
      </div>
      <div class="col-4">
        <label for="inc-amount">Amount (PHP)</label>
        <input type="number" id="inc-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-4">
        <label for="inc-source">Source</label>
        <select id="inc-source"></select>
      </div>
      <div class="col-12">
        <label for="inc-remarks">Remarks</label>
        <input type="text" id="inc-remarks" placeholder="optional" />
      </div>
    </div>
    <button class="btn" id="inc-submit">Submit Income</button>
  </section>

  <section id="tab-expenses" class="card" style="display:none">
    <div class="row">
      <div class="col-4">
        <label for="exp-date">Date</label>
        <input type="date" id="exp-date" />
      </div>
      <div class="col-4">
        <label for="exp-amount">Amount (PHP)</label>
        <input type="number" id="exp-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-4">
        <label for="exp-source">Source</label>
        <select id="exp-source"></select>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <label for="exp-category">Category</label>
        <select id="exp-category"></select>
      </div>
      <div class="col-12">
        <label for="exp-remarks">Remarks</label>
        <input type="text" id="exp-remarks" placeholder="optional" />
      </div>
    </div>
    <div class="sticky-actions">
      <button class="btn" id="exp-submit">Submit Expense</button>
    </div>
  </section>

  <section id="tab-view" class="card" style="display:none">
    <div class="row">
      <div class="col-3">
        <label for="filter-year">Year</label>
        <select id="filter-year"></select>
      </div>
      <div class="col-3">
        <label for="filter-month">Month</label>
        <select id="filter-month">
          <option value="">All</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
          <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
          <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
          <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
      </div>
      <div class="col-3">
        <label for="filter-source">Source</label>
        <select id="filter-source"><option value="">All</option></select>
      </div>
      <div class="col-3">
        <label for="filter-category">Category</label>
        <select id="filter-category"><option value="">All</option></select>
      </div>
    </div>

    <div class="totals stats">
      <div class="total stat ok"><strong>Income</strong><span id="tot-income">0.00</span></div>
      <div class="total stat danger"><strong>Expenses</strong><span id="tot-expense">0.00</span></div>
      <div class="total stat neutral"><strong>Net</strong><span id="tot-net">0.00</span></div>
    </div>
    <div class="flex" style="justify-content:flex-end; margin-top:8px; gap:8px;">
      <button class="btn secondary" id="health-check">Health</button>
      <button class="btn secondary" id="write-test">Write Test</button>
      <button class="btn secondary" id="ui-test">UI Test</button>
      <button class="btn secondary" id="refresh-view">Refresh</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="flex">
        <div class="muted">Log entries (Income + Expenses)</div>
        <div class="spacer"></div>
        <div class="chips" id="active-filters"></div>
      </div>
      <div class="table-controls" style="margin:8px 0 4px;">
        <div class="date-inline">
          <label for="filter-start">Start</label>
          <input type="date" id="filter-start" />
        </div>
        <div class="date-inline">
          <label for="filter-end">End</label>
          <input type="date" id="filter-end" />
        </div>
      </div>
      <table class="log-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Source</th>
            <th>Category</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
// ==== Apps Script JSONP client (reads + writes) ====
const API_BASE = 'https://script.google.com/macros/s/AKfycbzUZyKiHqXmr5CkAadfpkZn58110Vu5slgWzn-v-08Hd4JtYE0Mi1yPRu4vh4A1J9m2Jw/exec';

// Fallback lists so UI never appears empty
const FALLBACK_META = {
  incomeSources: ['Gcash','WCC','TMC-SL','Manila Med','Others'],
  expenseSources: ['Cash','Gcash','BPI CC','SB CB','SB RC','UnionBank'],
  defaultCategories: ['Duty Food','House Food','Kids','Personal','Utilities','Subscription','Media','Gas','Car','Grocery','Insurance','Clothing','Loan','Travel','Others']
};

// --- JSONP helpers ---
function jsonp(params, cbName){
  const url = new URL(API_BASE);
  const q = Object.assign({}, params||{});
  q._ts = Date.now(); // cache-bust
  Object.entries(q).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') url.searchParams.set(k, String(v)); });
  if (cbName) url.searchParams.set('callback', cbName);
  const s = document.createElement('script'); s.src = url.toString();
  s.onload = s.onerror = ()=> setTimeout(()=>s.remove(), 0);
  document.body.appendChild(s);
}
function jsonpWrite(action, params, cbName){ jsonp(Object.assign({action}, params||{}), cbName); }
function jsonpWithTimeout(action, params, cbName, onTimeout, ms){
  let done = false; const guard = setTimeout(()=>{ if(!done){ onTimeout && onTimeout(); } }, ms||7000);
  const wrapped = cbName + '_wrap_' + Math.random().toString(36).slice(2);
  window[wrapped] = (res)=>{ done = true; clearTimeout(guard); try{ window[cbName] && window[cbName](res); } finally { delete window[wrapped]; } };
  jsonpWrite(action, params, wrapped);
}

// --- Toast ---
function toast(msg, ok=true){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.borderColor = ok ? 'var(--ok)' : 'var(--danger)';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800);
}

// --- Tabs ---
function goTab(key){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    if (b.dataset.tab === key) b.classList.add('active'); else b.classList.remove('active');
  });
  document.querySelectorAll('section[id^="tab-"]').forEach(s=> s.style.display='none');
  document.getElementById('tab-'+key).style.display='';
  if (key === 'view') { refreshView(); }
}

document.querySelectorAll('.tab-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ goTab(btn.dataset.tab); }); });

// --- Meta population ---
let META = { incomeSources:[], expenseSources:[], defaultCategories:[] };
function populateFromMeta(meta){
  const m = meta || FALLBACK_META;
  META.incomeSources     = (m.incomeSources && m.incomeSources.length) ? m.incomeSources : FALLBACK_META.incomeSources;
  META.expenseSources    = (m.expenseSources && m.expenseSources.length) ? m.expenseSources : FALLBACK_META.expenseSources;
  META.defaultCategories = (m.defaultCategories && m.defaultCategories.length) ? m.defaultCategories : FALLBACK_META.defaultCategories;

  const incSel = document.getElementById('inc-source');
  if (incSel){ incSel.innerHTML=''; META.incomeSources.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; incSel.appendChild(o); }); }

  const expSel = document.getElementById('exp-source');
  if (expSel){ expSel.innerHTML=''; META.expenseSources.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; expSel.appendChild(o); }); }

  const catSel = document.getElementById('exp-category');
  if (catSel){ catSel.innerHTML=''; META.defaultCategories.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; catSel.appendChild(o); }); }
}

window.handleMeta = (d)=>{
  if (d && d.todayISO){
    document.getElementById('inc-date').value = d.todayISO;
    document.getElementById('exp-date').value = d.todayISO;
  }
  populateFromMeta(d);
};

function initUI(){
  // Year options (current ±4)
  const ySel = document.getElementById('filter-year');
  const now = new Date(), curY = now.getFullYear();
  ySel.innerHTML='';
  for(let y = curY+1; y >= curY-4; y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=y; if(y===curY) o.selected=true; ySel.appendChild(o); }
  // Preload UI with fallback then fetch real meta
  populateFromMeta(FALLBACK_META);
  jsonp({action:'getmeta'}, 'handleMeta');
}
initUI();

function parseAmount(el){ const v = Number(el.value); if(!isFinite(v) || v<=0) return null; return +v.toFixed(2); }

// --- Filters ---
function getFilters(){
  const year = Number(document.getElementById('filter-year').value) || null;
  const month = document.getElementById('filter-month').value ? Number(document.getElementById('filter-month').value) : null;
  const source = document.getElementById('filter-source').value || null;
  const category = document.getElementById('filter-category').value || null;
  const start = document.getElementById('filter-start').value || null;
  const end = document.getElementById('filter-end').value || null;
  return { year, month, source, category, start, end };
}

// --- Render logs ---
window.handleLogs = (payload)=>{
  const btn = document.getElementById('refresh-view');
  if (btn){ btn.disabled = false; btn.textContent = 'Refresh'; }
  if(!payload || !payload.ok){ toast('Failed to load logs', false); return; }
  const {rows, totals, sources, categories} = payload;

  document.getElementById('tot-income').textContent = (totals.income||0).toFixed(2);
  document.getElementById('tot-expense').textContent = (totals.expense||0).toFixed(2);
  const netEl = document.getElementById('tot-net');
  const netVal = (typeof totals.net === 'number') ? totals.net : ((totals.income||0)-(totals.expense||0));
  netEl.textContent = netVal.toFixed(2);
  netEl.parentElement.classList.remove('ok','danger','neutral');
  netEl.parentElement.classList.add(netVal>0 ? 'ok' : (netVal<0 ? 'danger' : 'neutral'));

  function keep(sel, items){ const cur = sel.value; sel.innerHTML = '<option value="">All</option>'; (items||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); if([...sel.options].some(o=>o.value===cur)) sel.value=cur; }
  keep(document.getElementById('filter-source'), sources);
  keep(document.getElementById('filter-category'), categories);

  const chips = document.getElementById('active-filters'); chips.innerHTML='';
  const f = getFilters();
  const addChip = (label,val)=>{ if(!val) return; const c=document.createElement('div'); c.className='chip'; c.textContent=label+': '+val; chips.appendChild(c); };
  addChip('Year', f.year); addChip('Month', f.month); addChip('Source', f.source); addChip('Category', f.category);

  const tbody = document.getElementById('log-body'); tbody.innerHTML='';
  (rows||[]).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-col="Type">${r.type}</td>
      <td data-col="Date">${r.dateISO}</td>
      <td data-col="Amount">${Number(r.amount).toFixed(2)}</td>
      <td data-col="Source">${r.source||''}</td>
      <td data-col="Category">${r.category||''}</td>
      <td data-col="Actions"><button class="delete-btn" data-sheet="${r.sheetName}" data-row="${r.sheetRow}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  toast(`Loaded ${rows?rows.length:0} row(s).`);

  tbody.querySelectorAll('.delete-btn').forEach(delBtn=>{
    delBtn.addEventListener('click', ()=>{
      const sheetName = delBtn.getAttribute('data-sheet');
      const sheetRow = delBtn.getAttribute('data-row');
      const summary = [...delBtn.closest('tr').children].slice(0,5).map(td=>td.textContent.trim()).join(' | ');
      if(!confirm(`Delete this entry?\n\n${summary}`)) return;
      delBtn.disabled = true;
      window.handleDelete = (res)=>{ if(res && res.ok){ toast('Deleted.'); refreshView(); } else { toast('Delete failed', false); delBtn.disabled=false; } };
      jsonpWithTimeout('delete', { sheetName, sheetRow }, 'handleDelete', ()=>{ delBtn.disabled=false; toast('Delete timed out', false); }, 7000);
    });
  });
};

function refreshView(){ jsonp(Object.assign({action:'fetchlogs'}, getFilters()), 'handleLogs'); }
function refreshViewUI(){
  const btn = document.getElementById('refresh-view');
  if (btn){ const prev = btn.textContent; btn.textContent = 'Refreshing…'; btn.disabled = true; setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 4000); }
  refreshView();
}

// --- Income submit ---
const incSubmit = document.getElementById('inc-submit');
incSubmit.addEventListener('click', ()=>{
  const dateISO = document.getElementById('inc-date').value;
  const amount = parseAmount(document.getElementById('inc-amount'));
  const source = document.getElementById('inc-source').value;
  const remarks = document.getElementById('inc-remarks').value.trim();
  if(!dateISO) return toast('Pick a date.', false);
  if(amount===null) return toast('Amount must be > 0', false);
  if(!source) return toast('Select a source.', false);
  incSubmit.disabled = true;
  window.handleWriteIncome = (res)=>{ incSubmit.disabled=false; if(res && res.ok){ toast('Income saved.'); document.getElementById('inc-amount').value=''; document.getElementById('inc-remarks').value=''; goTab('view'); setTimeout(refreshView, 150); } else { toast('Save failed', false);} };
  jsonpWithTimeout('addincome', { dateISO, amount, source, remarks }, 'handleWriteIncome', ()=>{ incSubmit.disabled=false; toast('Income save timed out', false); }, 7000);
});

// --- Expense submit ---
const expSubmit = document.getElementById('exp-submit');
expSubmit.addEventListener('click', ()=>{
  const dateISO = document.getElementById('exp-date').value;
  const amount = parseAmount(document.getElementById('exp-amount'));
  const source = document.getElementById('exp-source').value;
  const category = document.getElementById('exp-category').value;
  const remarks = document.getElementById('exp-remarks').value.trim();
  if(!dateISO) return toast('Pick a date.', false);
  if(amount===null) return toast('Amount must be > 0', false);
  if(!source) return toast('Select a source.', false);
  expSubmit.disabled = true;
  window.handleWriteExpense = (res)=>{ expSubmit.disabled=false; if(res && res.ok){ toast('Expense saved.'); document.getElementById('exp-amount').value=''; document.getElementById('exp-remarks').value=''; goTab('view'); setTimeout(refreshView, 150); } else { toast('Save failed', false);} };
  jsonpWithTimeout('addexpense', { dateISO, amount, source, category, remarks }, 'handleWriteExpense', ()=>{ expSubmit.disabled=false; toast('Expense save timed out', false); }, 7000);
});

// --- Filters & diagnostics ---
['filter-year','filter-month','filter-source','filter-category','filter-start','filter-end']
  .forEach(id=> document.getElementById(id).addEventListener('change', refreshView));

document.getElementById('refresh-view').addEventListener('click', refreshViewUI);

document.getElementById('health-check').addEventListener('click', ()=>{
  window.handleHealth = (d)=>{ if(d && d.ok){ toast(`Health OK • Income rows: ${d.incomeRows} • Expenses rows: ${d.expensesRows}`); } else { toast('Health failed', false);} };
  jsonp({action:'health'}, 'handleHealth');
});

document.getElementById('write-test').addEventListener('click', ()=>{
  window.handleAppendTest = (d)=>{ if(d && d.ok){ toast('Write test appended.'); refreshView(); } else { toast('Write test failed', false);} };
  jsonp({action:'appendtest'}, 'handleAppendTest');
});

// --- UI Test (no backend) ---
document.getElementById('ui-test').addEventListener('click', ()=>{
  const sample = {
    ok:true,
    totals:{ income: 1234.56, expense: 789.01, net: 445.55 },
    sources:['Gcash','BPI CC','Cash'],
    categories:['Grocery','Gas','Utilities','Kids'],
    rows:[
      { type:'Income', dateISO:'2025-11-03', amount:500.00, source:'Gcash', category:'', sheetName:'Income', sheetRow:2 },
      { type:'Expense', dateISO:'2025-11-03', amount:120.25, source:'Cash', category:'Grocery', sheetName:'Expenses', sheetRow:2 }
    ]
  };
  window.handleLogs(sample);
});

// Initial load
setTimeout(refreshView, 200);
</script>
</body>
</html>
