<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="color-scheme" content="dark" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Financial Tracker</title>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #10151c;
    --panel-2: #141a22;
    --text: #e6edf3;
    --muted: #aab6c3;
    --accent: #4f46e5;   /* indigo */
    --accent-2: #14b8a6; /* teal for "nice" moments */
    --danger: #ef4444;
    --ok: #22c55e;
    --input: #0f1720;
    --border: #1f2a37;
    --chip: #1a2230;
    --row-alt: #0f141b;
    --focus: #2563eb;
  }
  html, body {
    margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 1.4rem; margin: 0 0 12px; font-weight: 700; }
  .tabs { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .tab-btn {
    background: var(--panel); border: 1px solid var(--border); color: var(--text);
    padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
  }
  .tab-btn.active { background: var(--accent); border-color: var(--accent); }
  .card {
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 14px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
  }
  .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; margin-bottom: 12px; }
  .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
  label { display: block; font-size: 0.9rem; margin-bottom: 6px; color: var(--muted); }
  input[type="date"], input[type="number"], input[type="text"], select, datalist {
    width: 100%; background: var(--input); color: var(--text);
    border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
    outline: none;
  }
  input:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }
  .btn {
    background: var(--accent); border: 1px solid var(--accent); color: white;
    padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn.secondary { background: transparent; border: 1px solid var(--border); }
  .chips { display: flex; gap: 8px; flex-wrap: wrap; }
  .chip { background: var(--chip); border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; font-size: 0.85rem; color: var(--muted); }
  .totals { display: flex; gap: 10px; flex-wrap: wrap; }
  .total { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); }
  thead th { font-size: 0.85rem; color: var(--muted); }
  tbody tr:nth-child(even) { background: var(--row-alt); }
  .danger { color: var(--danger); }
  .ok { color: var(--ok); }
  .toast {
    position: fixed; right: 16px; bottom: 16px; background: var(--panel); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px; border-radius: 10px; opacity: 0; transform: translateY(10px);
    transition: all .2s ease; pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }
  .flex { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .spacer { flex: 1; }
  .delete-btn {
    background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 6px 10px;
    border-radius: 8px; cursor: pointer; font-weight: 700;
  }
  .muted { color: var(--muted); font-size: 0.9rem; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Financial Tracker</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="income">Income</button>
    <button class="tab-btn" data-tab="expenses">Expenses</button>
    <button class="tab-btn" data-tab="view">View</button>
  </div>

  <!-- Income Tab -->
  <section id="tab-income" class="card">
    <div class="row">
      <div class="col-4">
        <label for="inc-date">Date</label>
        <input type="date" id="inc-date" />
      </div>
      <div class="col-4">
        <label for="inc-amount">Amount (PHP)</label>
        <input type="number" id="inc-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-4">
        <label for="inc-source">Source</label>
        <select id="inc-source"></select>
      </div>
      <div class="col-12">
        <label for="inc-remarks">Remarks</label>
        <input type="text" id="inc-remarks" placeholder="optional" />
      </div>
    </div>
    <button class="btn" id="inc-submit">Submit Income</button>
  </section>

  <!-- Expenses Tab -->
  <section id="tab-expenses" class="card" style="display:none">
    <div class="row">
      <div class="col-3">
        <label for="exp-date">Date</label>
        <input type="date" id="exp-date" />
      </div>
      <div class="col-3">
        <label for="exp-amount">Amount (PHP)</label>
        <input type="number" id="exp-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-3">
        <label for="exp-source">Source</label>
        <select id="exp-source"></select>
      </div>
      <div class="col-3">
        <label for="exp-category">Category</label>
        <!-- free text allowed with suggestions -->
        <input list="exp-categories" id="exp-category" placeholder="Start typing or pick..." />
        <datalist id="exp-categories"></datalist>
      </div>
      <div class="col-12">
        <label for="exp-remarks">Remarks</label>
        <input type="text" id="exp-remarks" placeholder="optional" />
      </div>
    </div>
    <button class="btn" id="exp-submit">Submit Expense</button>
  </section>

  <!-- View Tab -->
  <section id="tab-view" class="card" style="display:none">
    <div class="row">
      <div class="col-3">
        <label for="filter-year">Year</label>
        <select id="filter-year"></select>
      </div>
      <div class="col-3">
        <label for="filter-month">Month</label>
        <select id="filter-month">
          <option value="">All</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
          <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
          <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
          <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
      </div>
      <div class="col-3">
        <label for="filter-source">Source</label>
        <select id="filter-source"><option value="">All</option></select>
      </div>
      <div class="col-3">
        <label for="filter-category">Category</label>
        <select id="filter-category"><option value="">All</option></select>
      </div>
    </div>

    <div class="totals">
      <div class="total"><strong>Income:</strong> <span id="tot-income" class="ok">0.00</span></div>
      <div class="total"><strong>Expenses:</strong> <span id="tot-expense" class="danger">0.00</span></div>
      <div class="total"><strong>Net:</strong> <span id="tot-net">0.00</span></div>
      <div class="spacer"></div>
      <button class="btn secondary" id="refresh-view">Refresh</button>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="flex">
        <div class="muted">Log entries (Income + Expenses)</div>
        <div class="spacer"></div>
        <div class="chips" id="active-filters"></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Source</th>
            <th>Category</th>
            <th>Remarks</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
// Meta injected from server
const META = <?= JSON.stringify(meta) ?>;

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('section[id^="tab-"]').forEach(s => s.style.display = 'none');
    document.getElementById('tab-' + tab).style.display = '';
  });
});

// Toast
function toast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = ok ? 'var(--ok)' : 'var(--danger)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Populate selects
function initUI() {
  // Defaults
  google.script.run.withSuccessHandler(({todayISO}) => {
    document.getElementById('inc-date').value = todayISO;
    document.getElementById('exp-date').value = todayISO;
  }).getMeta();

  // Income sources
  const incSel = document.getElementById('inc-source');
  META.incomeSources.forEach(v => {
    const o = document.createElement('option'); o.value = o.textContent = v; incSel.appendChild(o);
  });
  // Expense sources
  const expSel = document.getElementById('exp-source');
  META.expenseSources.forEach(v => {
    const o = document.createElement('option'); o.value = o.textContent = v; expSel.appendChild(o);
  });
  // Categories datalist
  const dl = document.getElementById('exp-categories');
  META.defaultCategories.forEach(v => {
    const o = document.createElement('option'); o.value = v; dl.appendChild(o);
  });

  // Year options: current year Â± 4
  const ySel = document.getElementById('filter-year');
  const now = new Date();
  const curY = now.getFullYear();
  for (let y = curY + 1; y >= curY - 4; y--) {
    const o = document.createElement('option');
    o.value = String(y); o.textContent = y; if (y === curY) o.selected = true;
    ySel.appendChild(o);
  }
}
initUI();

// Validations
function parseAmount(el) {
  const v = Number(el.value);
  if (!isFinite(v) || v <= 0) return null;
  return +v.toFixed(2);
}

// Submit Income
document.getElementById('inc-submit').addEventListener('click', () => {
  const dateISO = document.getElementById('inc-date').value;
  const amount = parseAmount(document.getElementById('inc-amount'));
  const source = document.getElementById('inc-source').value;
  const remarks = document.getElementById('inc-remarks').value.trim();

  if (!dateISO) return toast('Pick a date, time traveler.', false);
  if (amount === null) return toast('Amount must be > 0.', false);
  if (!source) return toast('Select a source.', false);

  document.getElementById('inc-submit').disabled = true;
  google.script.run.withSuccessHandler(() => {
    toast('Income saved.');
    document.getElementById('inc-amount').value = '';
    document.getElementById('inc-remarks').value = '';
    document.getElementById('inc-submit').disabled = false;
  }).withFailureHandler(err => {
    toast(err.message || 'Failed to save income.', false);
    document.getElementById('inc-submit').disabled = false;
  }).addIncome({dateISO, amount, source, remarks});
});

// Submit Expense
document.getElementById('exp-submit').addEventListener('click', () => {
  const dateISO = document.getElementById('exp-date').value;
  const amount = parseAmount(document.getElementById('exp-amount'));
  const source = document.getElementById('exp-source').value;
  const category = document.getElementById('exp-category').value.trim();
  const remarks = document.getElementById('exp-remarks').value.trim();

  if (!dateISO) return toast('Pick a date, oracle.', false);
  if (amount === null) return toast('Amount must be > 0.', false);
  if (!source) return toast('Select a source.', false);

  document.getElementById('exp-submit').disabled = true;
  google.script.run.withSuccessHandler(() => {
    toast('Expense saved.');
    document.getElementById('exp-amount').value = '';
    document.getElementById('exp-remarks').value = '';
    // leave category sticky, because humans repeat themselves
    document.getElementById('exp-submit').disabled = false;
  }).withFailureHandler(err => {
    toast(err.message || 'Failed to save expense.', false);
    document.getElementById('exp-submit').disabled = false;
  }).addExpense({dateISO, amount, source, category, remarks});
});

// View tab logic
const filterIds = ['filter-year','filter-month','filter-source','filter-category'];
filterIds.forEach(id => document.getElementById(id).addEventListener('change', refreshView));
document.getElementById('refresh-view').addEventListener('click', refreshView);

function getFilters() {
  const year = Number(document.getElementById('filter-year').value) || null;
  const month = document.getElementById('filter-month').value ? Number(document.getElementById('filter-month').value) : null;
  const source = document.getElementById('filter-source').value || null;
  const category = document.getElementById('filter-category').value || null;
  return { year, month, source, category };
}

function refreshView() {
  const filters = getFilters();
  google.script.run.withSuccessHandler(renderView).withFailureHandler(err => {
    toast(err.message || 'Failed to load logs.', false);
  }).fetchLogs(filters);
}

// initial view load after short delay to allow year dropdown populate
setTimeout(refreshView, 300);

// render
function renderView({ok, rows, totals, sources, categories}) {
  if (!ok) return;
  document.getElementById('tot-income').textContent = (totals.income || 0).toFixed(2);
  document.getElementById('tot-expense').textContent = (totals.expense || 0).toFixed(2);
  document.getElementById('tot-net').textContent = (totals.net || 0).toFixed(2);

  // Update filter choices for Source/Category
  const srcSel = document.getElementById('filter-source');
  const catSel = document.getElementById('filter-category');
  const keep = (sel, items) => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">All</option>';
    items.forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
    });
    if ([...sel.options].some(o => o.value === cur)) sel.value = cur;
  };
  keep(srcSel, sources);
  keep(catSel, categories);

  // Active filter chips
  const chips = document.getElementById('active-filters');
  chips.innerHTML = '';
  const f = getFilters();
  const addChip = (label, val) => {
    if (!val) return;
    const c = document.createElement('div'); c.className = 'chip'; c.textContent = label + ': ' + val; chips.appendChild(c);
  };
  addChip('Year', f.year);
  addChip('Month', f.month);
  addChip('Source', f.source);
  addChip('Category', f.category);

  // Rows
  const tbody = document.getElementById('log-body');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.type}</td>
      <td>${r.dateISO}</td>
      <td>${Number(r.amount).toFixed(2)}</td>
      <td>${r.source || ''}</td>
      <td>${r.category || ''}</td>
      <td>${escapeHtml(r.remarks || '')}</td>
      <td><button class="delete-btn" data-sheet="${r.sheetName}" data-row="${r.sheetRow}">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });

  // hook deletes
  tbody.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const sheet = btn.getAttribute('data-sheet');
      const row = Number(btn.getAttribute('data-row'));
      // Confirm summary
      const summary = [...btn.closest('tr').children].slice(0,6).map(td => td.textContent.trim()).join(' | ');
      if (!confirm(`Delete this entry?\n\n${summary}`)) return;
      btn.disabled = true;
      google.script.run.withSuccessHandler(() => {
        toast('Deleted.');
        refreshView();
      }).withFailureHandler(err => {
        toast(err.message || 'Delete failed.', false);
        btn.disabled = false;
      }).deleteEntry(sheet, row);
    });
  });
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
</script>
</body>
</html>
