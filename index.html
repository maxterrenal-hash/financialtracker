<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark" />
<title>Financial Tracker</title>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #10151c;
    --panel-2: #141a22;
    --text: #e6edf3;
    --muted: #aab6c3;
    --accent: #7c3aed; /* closer to the HHA violet accent */
    --accent-2: #22d3ee; /* cyan for highlights */
    --danger: #ef4444;
    --ok: #22c55e;
    --input: #0f1720;
    --border: #1f2a37;
    --chip: #18202d;
    --row-alt: #0f141b;
    --focus: #7c3aed;
  }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }
  * { -webkit-tap-highlight-color: transparent; }
  .wrap { width: 100%; max-width: 520px; margin: 0 auto; padding: 12px 14px 80px; }
  h1 { font-size: 1.25rem; margin: 0 0 10px; font-weight: 800; letter-spacing: 0.2px; }

  /* Tabs mimic HHA pills and stick to top on mobile */
  .tabs { position: sticky; top: 0; z-index: 50; display:flex; gap:8px; margin:0 0 12px; padding: 8px 0; background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.8)); backdrop-filter: blur(6px); }
  .tab-btn { flex:1; text-align:center; background:var(--panel); border:1px solid var(--border); color:var(--text); padding:12px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size: 0.95rem; min-width:0; }
  .tab-btn.active { background: var(--accent); border-color: var(--accent); }

  /* Cards */
  .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:12px; box-shadow: 0 0 0 1px rgba(255,255,255,.02) inset; }

  /* Mobile-first form grid */
  .row { display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px; }
  @media (min-width: 480px){ .row { grid-template-columns: repeat(12, 1fr); } .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; } }
  label { display:block; font-size:.85rem; margin-bottom:6px; color:var(--muted); font-weight:600; }

  input[type="date"], input[type="number"], input[type="text"], select, datalist {
    width:100%; background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:14px 12px; outline:none; font-size:16px; /* prevent iOS zoom */
  }
  input:focus, select:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(124,58,237,.25); }

  .btn { width:100%; background:var(--accent); border:1px solid var(--accent); color:white; padding:14px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:1rem; letter-spacing:.2px; }
  .btn.secondary { width:auto; background: transparent; border:1px solid var(--border); padding:12px 14px; border-radius:12px; font-weight:700; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }

  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:.8rem; color:var(--muted); }

  .totals { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .total { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-weight:700; }
  .danger { color: var(--danger); }
  .ok { color: var(--ok); }

  /* Table becomes card list on small screens */
  table { width:100%; border-collapse: collapse; margin-top:8px; table-layout: fixed; }
  th, td { text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); word-break: break-word; overflow-wrap: anywhere; hyphens: auto; }
  thead th { font-size:.8rem; color:var(--muted); }
  tbody tr:nth-child(even) { background: var(--row-alt); }

  @media (max-width: 640px){
    thead { display:none; }
    table, tbody, tr, td { display:block; width:100%; }
    tr { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; margin-bottom:10px; overflow:hidden; }
    td { border: none; padding: 10px 12px 10px 112px; position: relative; min-height: 44px; }
    td::before { content: attr(data-col); position: absolute; left: 12px; top: 10px; color: var(--muted); font-size: .78rem; font-weight: 700; letter-spacing: .2px; }
    td:last-child { padding-left: 12px; display:flex; justify-content:flex-end; }
  }

  .toast { position:fixed; right:12px; bottom:12px; background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; opacity:0; transform: translateY(10px); transition: all .2s ease; pointer-events:none; }
  .toast.show { opacity:1; transform: translateY(0); }

  /* Sticky bottom action for mobile submit forms like HHA */
  .sticky-actions { position: sticky; bottom: 0; padding-top: 8px; background: linear-gradient(180deg, transparent, rgba(11,15,20,.9)); }
  .table-controls { display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; }
  .table-controls .date-inline label { display:block; font-size:.78rem; color:var(--muted); margin-bottom:4px; font-weight:700; }
  .table-controls input[type="date"] { width:100%; background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px; }
  @media (max-width: 420px){ .table-controls { grid-template-columns: 1fr; } }
  /* Ensure long text wraps inside table borders */
  td[data-col="Category"], td[data-col="Remarks"],
  tbody td:nth-child(5), tbody td:nth-child(6) { white-space: normal; }
  /* Constrain last column actions so it doesn't push layout */
  td[data-col="Actions"] { white-space: nowrap; }
  /* Keep inputs from exceeding their containers */
  *, *::before, *::after { box-sizing: border-box; }
  input, select, textarea { max-width: 100%; }
  #inc-remarks, #exp-remarks { display:block; width:100%; max-width:100%; }
  .wrap { overflow-x: hidden; }
  /* Combobox styling to match selects */
  .combo { position: relative; }
  .combo input {
    appearance: none; -webkit-appearance: none; width: 100%;
    background: var(--input); color: var(--text);
    border: 1px solid var(--border); border-radius: 12px;
    padding: 14px 40px 14px 12px; outline: none; font-size: 16px;
  }
  .combo input:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(124,58,237,.25); }
  .combo::after { content: ""; position: absolute; right: 12px; top: 50%; transform: translateY(-25%);
    width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 7px solid var(--muted); pointer-events: none; }
  /* Stats bar: 3 consistent cards (Income, Expenses, Net) */
  .totals.stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; align-items:stretch; }
  
  .total.stat { text-align:center; padding:12px; border-radius:14px; border:1px solid var(--border); background: linear-gradient(180deg, var(--panel), var(--panel-2)); min-width:0; }
  .total.stat strong { display:block; font-size:.78rem; color:var(--muted); font-weight:800; letter-spacing:.2px; margin-bottom:4px; }
  .total.stat span { display:block; font-size:1.25rem; font-weight:900; }
  .total.stat.ok span { color: var(--ok); }
  .total.stat.danger span { color: var(--danger); }
  .total.stat.neutral span { color: var(--text); }
  
  .totals .spacer { display:none !important; }
  .totals #refresh-view { grid-column: 1 / -1; justify-self: end; }
  /* Log table polish for consistency */
  .log-table thead th { text-transform: uppercase; letter-spacing:.04em; }
  .log-table tbody tr { transition: background .15s ease, transform .05s ease; }
  .log-table tbody tr:hover { background: rgba(124,58,237,.08); }
  .delete-btn { background: transparent; color: var(--danger); border:1px solid var(--danger); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; }
  .delete-btn:hover { background: rgba(239,68,68,.1); }
  /* Tiny screens: keep 3 stats in a row but breathe with smaller type/padding */
  @media (max-width: 400px){
    .totals.stats { grid-template-columns: repeat(3, 1fr); }
    .total.stat { padding: 8px; }
    .total.stat strong { font-size: .72rem; }
    .total.stat span { font-size: 1.05rem; }
  }
  @media (max-width: 340px){
    .total.stat { padding: 6px; }
    .total.stat strong { font-size: .68rem; }
    .total.stat span { font-size: .98rem; }
  }
  /* Mobile hardening: prevent horizontal scroll and allow stat cards/buttons to shrink safely */
  html, body { overflow-x: hidden; }
  /* Mobile fix: keep log date pickers within table width */
  .table-controls { max-width: 100%; }
  .table-controls .date-inline { min-width: 0; }
  .table-controls input[type="date"] { width:100%; max-width:100%; min-width:0; }
  @media (max-width: 640px){ .table-controls { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Financial Tracker</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="income">Income</button>
    <button class="tab-btn" data-tab="expenses">Expenses</button>
    <button class="tab-btn" data-tab="view">View</button>
  </div>

  <section id="tab-income" class="card">
    <div class="row">
      <div class="col-4">
        <label for="inc-date">Date</label>
        <input type="date" id="inc-date" />
      </div>
      <div class="col-4">
        <label for="inc-amount">Amount (PHP)</label>
        <input type="number" id="inc-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-4">
        <label for="inc-source">Source</label>
        <select id="inc-source"></select>
      </div>
      <div class="col-12">
        <label for="inc-remarks">Remarks</label>
        <input type="text" id="inc-remarks" placeholder="optional" />
      </div>
    </div>
    <button class="btn" id="inc-submit">Submit Income</button>
  </section>

  <section id="tab-expenses" class="card" style="display:none">
    <div class="row">
      <div class="col-4">
        <label for="exp-date">Date</label>
        <input type="date" id="exp-date" />
      </div>
      <div class="col-4">
        <label for="exp-amount">Amount (PHP)</label>
        <input type="number" id="exp-amount" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
      </div>
      <div class="col-4">
        <label for="exp-source">Source</label>
        <select id="exp-source"></select>
      </div>
    </div>
    <!-- Category moved below the first row as full width -->
    <div class="row">
      <div class="col-12">
        <label for="exp-category">Category</label>
        <div class="combo">
          <input list="exp-categories" id="exp-category" placeholder="Start typing or pick..." />
        </div>
        <datalist id="exp-categories"></datalist>
      </div>
      <div class="col-12">
        <label for="exp-remarks">Remarks</label>
        <input type="text" id="exp-remarks" placeholder="optional" />
      </div>
    </div>
    <div class="sticky-actions">
      <button class="btn" id="exp-submit">Submit Expense</button>
    </div>
  </section>

  <section id="tab-view" class="card" style="display:none">
    <div class="row">
      <div class="col-3">
        <label for="filter-year">Year</label>
        <select id="filter-year"></select>
      </div>
      <div class="col-3">
        <label for="filter-month">Month</label>
        <select id="filter-month">
          <option value="">All</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
          <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
          <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
          <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
      </div>
      <div class="col-3">
        <label for="filter-source">Source</label>
        <select id="filter-source"><option value="">All</option></select>
      </div>
      <div class="col-3">
        <label for="filter-category">Category</label>
        <select id="filter-category"><option value="">All</option></select>
      </div>
    </div>

    <div class="totals stats">
      <div class="total stat ok"><strong>Income</strong><span id="tot-income">0.00</span></div>
      <div class="total stat danger"><strong>Expenses</strong><span id="tot-expense">0.00</span></div>
      <div class="total stat neutral"><strong>Net</strong><span id="tot-net">0.00</span></div>
    </div>
    <div class="flex" style="justify-content:flex-end; margin-top:8px;">
      <button class="btn secondary" id="refresh-view">Refresh</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="flex">
        <div class="muted">Log entries (Income + Expenses)</div>
        <div class="spacer"></div>
        <div class="chips" id="active-filters"></div>
      </div>
      <!-- Inline date range just for the table width -->
      <div class="table-controls" style="margin:8px 0 4px;">
        <div class="date-inline">
          <label for="filter-start">Start</label>
          <input type="date" id="filter-start" />
        </div>
        <div class="date-inline">
          <label for="filter-end">End</label>
          <input type="date" id="filter-end" />
        </div>
      </div>
      <table class="log-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Source</th>
            <th>Category</th>
            
            <th></th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
// Mock META (replaces <?= JSON.stringify(meta) ?>)
const META = {
  incomeSources: ['Gcash','WCC','TMC-SL','Manila Med','Others'],
  expenseSources: ['Cash','Gcash','BPI CC','SB CB','SB RC','UnionBank'],
  defaultCategories: ['Duty Food','House Food','Kids','Personal','Utilities','Subscription','Media','Gas','Car','Grocery','Insurance','Clothing','Loan','Travel','Others']
};

// Minimal mock of google.script.run
const google = {
  script: {
    run: {
      withSuccessHandler(fn){ this._ok = fn; return this; },
      withFailureHandler(fn){ this._fail = fn; return this; },
      getMeta(){ setTimeout(()=>this._ok({ todayISO: new Date().toISOString().slice(0,10) }), 100); },
      addIncome(payload){ mockAdd('Income', payload, this); },
      addExpense(payload){ mockAdd('Expense', payload, this); },
      fetchLogs(filters){ setTimeout(()=> this._ok(mockFetch(filters)), 120); },
      deleteEntry(sheetName, sheetRow){ mockDelete(sheetName, sheetRow, this); }
    }
  }
};

// In-memory mock data
let ledger = [
  {type:'Income', dateISO:'2025-11-01', amount:12000, source:'Manila Med', category:'', remarks:'Honorarium', sheetName:'Income', sheetRow:2},
  {type:'Expense', dateISO:'2025-11-01', amount:350, source:'Cash', category:'Duty Food', remarks:'ED snacks', sheetName:'Expenses', sheetRow:2},
  {type:'Expense', dateISO:'2025-11-02', amount:2200, source:'Gcash', category:'Grocery', remarks:'Weekend run', sheetName:'Expenses', sheetRow:3},
  {type:'Income', dateISO:'2025-11-03', amount:5000, source:'WCC', category:'', remarks:'Lecture', sheetName:'Income', sheetRow:3},
];

function nextRow(sheetName){
  const same = ledger.filter(r => r.sheetName===sheetName);
  return same.length ? Math.max(...same.map(r=>r.sheetRow))+1 : 2;
}

function mockAdd(type, payload, ctx){
  const entry = {
    type,
    dateISO: payload.dateISO,
    amount: Number(payload.amount),
    source: payload.source,
    category: type==='Expense' ? (payload.category||'') : '',
    remarks: payload.remarks || '',
    sheetName: type==='Income' ? 'Income' : 'Expenses',
    sheetRow: nextRow(type==='Income' ? 'Income' : 'Expenses')
  };
  if (!(entry.amount>0)) { ctx._fail?.({message:'Amount must be > 0.'}); return; }
  ledger.push(entry);
  setTimeout(()=> ctx._ok?.({ok:true}), 120);
}

function mockFetch(filters){
  let rows = ledger.slice();
  rows = rows.filter(r => {
    const [y,m,d] = r.dateISO.split('-').map(x=>parseInt(x,10));
    const rowDate = new Date(y, m-1, d);
    if (filters.year && y !== Number(filters.year)) return false;
    if (filters.month && m !== Number(filters.month)) return false;
    if (filters.start){ const s = new Date(filters.start); if (rowDate < s) return false; }
    if (filters.end){ const e = new Date(filters.end); if (rowDate > e) return false; }
    if (filters.source && filters.source !== '' && r.source !== filters.source) return false;
    if (filters.category && filters.category !== '' && (r.category||'') !== filters.category) return false;
    return true;
  });
  rows.sort((a,b)=> a.dateISO<b.dateISO ? 1 : a.dateISO>b.dateISO ? -1 : a.type.localeCompare(b.type));
  const totals = rows.reduce((acc,r)=>{ if(r.type==='Income') acc.income+=(+r.amount||0); else acc.expense+=(+r.amount||0); return acc; }, {income:0,expense:0});
  totals.net = +(totals.income - totals.expense).toFixed(2);
  const sources = Array.from(new Set(rows.map(r=>r.source).filter(Boolean))).sort();
  const categories = Array.from(new Set(rows.map(r=>r.category).filter(Boolean))).sort();
  return { ok:true, rows, totals, sources, categories };
}

function mockDelete(sheetName, sheetRow, ctx){
  const idx = ledger.findIndex(r => r.sheetName===sheetName && r.sheetRow===Number(sheetRow));
  if (idx === -1) { ctx._fail?.({message:'Not found'}); return; }
  ledger.splice(idx, 1);
  setTimeout(()=> ctx._ok?.({ok:true}), 100);
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('section[id^="tab-"]').forEach(s => s.style.display = 'none');
    document.getElementById('tab-' + tab).style.display = '';
  });
});

// Toast
function toast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = ok ? 'var(--ok)' : 'var(--danger)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

// Populate selects and init
function initUI() {
  google.script.run.withSuccessHandler(({todayISO}) => {
    document.getElementById('inc-date').value = todayISO;
    document.getElementById('exp-date').value = todayISO;
  }).getMeta();

  const incSel = document.getElementById('inc-source');
  META.incomeSources.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; incSel.appendChild(o); });
  const expSel = document.getElementById('exp-source');
  META.expenseSources.forEach(v => { const o=document.createElement('option'); o.value=o.textContent=v; expSel.appendChild(o); });
  const dl = document.getElementById('exp-categories');
  META.defaultCategories.forEach(v => { const o=document.createElement('option'); o.value=v; dl.appendChild(o); });

  const ySel = document.getElementById('filter-year');
  const now = new Date(); const curY = now.getFullYear();
  for (let y = curY + 1; y >= curY - 4; y--) {
    const o = document.createElement('option');
    o.value = String(y); o.textContent = y; if (y === curY) o.selected = true;
    ySel.appendChild(o);
  }
}
initUI();

function parseAmount(el){ const v = Number(el.value); if(!isFinite(v) || v<=0) return null; return +v.toFixed(2); }

document.getElementById('inc-submit').addEventListener('click', () => {
  const dateISO = document.getElementById('inc-date').value;
  const amount = parseAmount(document.getElementById('inc-amount'));
  const source = document.getElementById('inc-source').value;
  const remarks = document.getElementById('inc-remarks').value.trim();
  if(!dateISO) return toast('Pick a date.', false);
  if(amount===null) return toast('Amount must be > 0.', false);
  if(!source) return toast('Select a source.', false);
  const btn = document.getElementById('inc-submit'); btn.disabled = true;
  google.script.run.withSuccessHandler(()=>{
    toast('Income saved.');
    document.getElementById('inc-amount').value='';
    document.getElementById('inc-remarks').value='';
    btn.disabled=false; refreshView();
  }).withFailureHandler(err=>{ toast(err.message||'Failed.', false); btn.disabled=false; }).addIncome({dateISO, amount, source, remarks});
});

document.getElementById('exp-submit').addEventListener('click', () => {
  const dateISO = document.getElementById('exp-date').value;
  const amount = parseAmount(document.getElementById('exp-amount'));
  const source = document.getElementById('exp-source').value;
  const category = document.getElementById('exp-category').value.trim();
  const remarks = document.getElementById('exp-remarks').value.trim();
  if(!dateISO) return toast('Pick a date.', false);
  if(amount===null) return toast('Amount must be > 0.', false);
  if(!source) return toast('Select a source.', false);
  const btn = document.getElementById('exp-submit'); btn.disabled = true;
  google.script.run.withSuccessHandler(()=>{
    toast('Expense saved.');
    document.getElementById('exp-amount').value='';
    document.getElementById('exp-remarks').value='';
    btn.disabled=false; refreshView();
  }).withFailureHandler(err=>{ toast(err.message||'Failed.', false); btn.disabled=false; }).addExpense({dateISO, amount, source, category, remarks});
});

const filterIds = ['filter-year','filter-month','filter-source','filter-category','filter-start','filter-end'];
filterIds.forEach(id => document.getElementById(id).addEventListener('change', refreshView));
document.getElementById('refresh-view').addEventListener('click', refreshView);

function getFilters(){
  const year = Number(document.getElementById('filter-year').value) || null;
  const month = document.getElementById('filter-month').value ? Number(document.getElementById('filter-month').value) : null;
  const source = document.getElementById('filter-source').value || null;
  const category = document.getElementById('filter-category').value || null;
  const start = document.getElementById('filter-start').value || null;
  const end = document.getElementById('filter-end').value || null;
  return { year, month, source, category, start, end };
}

function refreshView(){
  const filters = getFilters();
  google.script.run.withSuccessHandler(renderView).withFailureHandler(err=>{
    toast(err.message||'Failed to load.', false);
  }).fetchLogs(filters);
}

setTimeout(refreshView, 200);

function renderView({ok, rows, totals, sources, categories}){
  if(!ok) return;
  document.getElementById('tot-income').textContent = (totals.income||0).toFixed(2);
  document.getElementById('tot-expense').textContent = (totals.expense||0).toFixed(2);
  const netEl = document.getElementById('tot-net');
  const netVal = (typeof totals.net === 'number' ? totals.net : ((totals.income||0)-(totals.expense||0)));
  netEl.textContent = netVal.toFixed(2);
  netEl.classList.remove('ok','danger');
  if (netVal > 0) netEl.classList.add('ok');
  else if (netVal < 0) netEl.classList.add('danger');
  const srcSel = document.getElementById('filter-source');
  const catSel = document.getElementById('filter-category');
  const keep = (sel, items) => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">All</option>';
    items.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    if ([...sel.options].some(o => o.value === cur)) sel.value = cur;
  };
  keep(srcSel, sources);
  keep(catSel, categories);

  const chips = document.getElementById('active-filters');
  chips.innerHTML = '';
  const f = getFilters();
  const addChip = (label, val) => { if(!val) return; const c=document.createElement('div'); c.className='chip'; c.textContent = label+': '+val; chips.appendChild(c); };
  addChip('Year', f.year);
  addChip('Month', f.month);
  addChip('Source', f.source);
  addChip('Category', f.category);

  const tbody = document.getElementById('log-body');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-col="Type">${r.type}</td>
      <td data-col="Date">${r.dateISO}</td>
      <td data-col="Amount">${Number(r.amount).toFixed(2)}</td>
      <td data-col="Source">${r.source||''}</td>
      <td data-col="Category">${r.category||''}</td>
      <td data-col="Actions"><button class="delete-btn" data-sheet="${r.sheetName}" data-row="${r.sheetRow}">Delete</button></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const sheet = btn.getAttribute('data-sheet');
      const row = Number(btn.getAttribute('data-row'));
      const summary = [...btn.closest('tr').children].slice(0,5).map(td=>td.textContent.trim()).join(' | ');
      if(!confirm(`Delete this entry?\n\n${summary}`)) return;
      btn.disabled = true;
      google.script.run.withSuccessHandler(()=>{ toast('Deleted.'); refreshView(); })
        .withFailureHandler(err=>{ toast(err.message||'Delete failed.', false); btn.disabled=false; })
        .deleteEntry(sheet, row);
    });
  });
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
</script>
</body>
</html>
